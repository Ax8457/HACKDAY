FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive
WORKDIR /app

RUN apt-get update && apt-get install -y \
    curl gnupg wget ca-certificates cron libssl3 \
    && wget -qO- https://www.mongodb.org/static/pgp/server-6.0.asc | gpg --dearmor > /etc/apt/trusted.gpg.d/mongodb-6.0.gpg \
    && echo "deb [ arch=amd64 ] https://repo.mongodb.org/apt/ubuntu jammy/mongodb-org/6.0 multiverse" | tee /etc/apt/sources.list.d/mongodb-org-6.0.list \
    && apt-get update && apt-get install -y mongodb-org=6.0.26 \
    && rm -rf /var/lib/apt/lists/*

COPY target/debug/challHackdayWeb /app/server
COPY static /app/static
COPY templates /app/templates
COPY initi_db.sh /app/

RUN echo '#!/bin/bash \n\
mongosh hackday --eval "db.users.drop(); db.appointments.drop();" \n\
/app/initi_db.sh' > /app/reset_db.sh && chmod +x /app/reset_db.sh

RUN echo "0 * * * * root /app/reset_db.sh >> /var/log/cron.log 2>&1" > /etc/cron.d/reset-db \
    && chmod 0644 /etc/cron.d/reset-db \
    && crontab /etc/cron.d/reset-db

RUN echo '#!/bin/bash \n\
mkdir -p /data/db \n\
mongod --fork --logpath /var/log/mongodb.log \n\
service cron start \n\
until mongosh --eval "db.adminCommand(\"ping\")" > /dev/null 2>&1; do sleep 1; done \n\
chmod +x /app/initi_db.sh \n\
/app/initi_db.sh \n\
exec ./server' > /app/entrypoint.sh && chmod +x /app/entrypoint.sh

EXPOSE 8000

CMD ["/app/entrypoint.sh"]
